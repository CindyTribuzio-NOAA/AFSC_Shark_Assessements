/*
Groundfish total catch by species     
Detail with Processor/Vessel Characteristics, Observer and EM Coverage
This report is based on the comprehensive_blend_ca table in the council schema in the akfin database
The following sql query replicates this report
Field names may be slightly different than in answers. I added comments when not intuitive, but let me know if you have questions

*/

--select columns
select
year,	
week_end_date,	
fmp_area,	
fmp_subarea,	
--NMFS Area	
reporting_area_code,
agency_gear_code,
trip_target_group,	
trip_target_name,
species_group_name,
species_name,
--Processor Federal Permit
processor_permit_id,
--Processor Name	
ito_company processor_name,
--Processor Plant/Operation	
ito_plant processor_plant,
ves_akr_adfg,
ves_akr_name,	
ves_akr_length,	
retained_or_discarded,
--# Distinct Processors	and # distinct vessel are always 1...
count(distinct(processor_permit_id)) distinct_processor,
count(distinct(vessel_id)) distinct_vessel,
--Catch (mt)	
sum(weight_posted) catch_mt,
gf_harvest_sector,
deployment_trip_start_date,	
deployment_trip_end_date,
deployment_trip_pk,	
monitoring_status,	
sampling_strata_deployment_category,
sampling_strata,
sampling_strata_name,	
sampling_strata_selection_rate
--identify table
from council.comprehensive_blend_ca
--where statements apply filters. These are the defaults from the answers dashboard
where year between 2017 and 2022
and fmp_area = 'GOA'
and trip_target_group in ('Flatfish', 'Pacific Cod', 'Pollock', 'Rockfish', 'Sablefish')
and species_name ='shark, spiny dogfish'
--commented out filters below are blank in answers.
--and trip_target_name in ('Pacific Cod', 'Rockfish', 'Sablefish')
--and fmp_subarea = 'WG'
--and reporting_area_code = 610
--and fmp_gear = 'HAL'
--and species_group_name = 'PCOD' 
--group by statement aggregates catch_mt, distinct_processors, and distinct_vessels by all of the other fields
group by year,	
week_end_date,	
fmp_area,	
fmp_subarea,	
reporting_area_code,
agency_gear_code,
trip_target_group,	
trip_target_name,
species_group_name,
species_name,
processor_permit_id,	
ito_company,
ito_plant,
ves_akr_adfg,
ves_akr_name,	
ves_akr_length,	
retained_or_discarded,
gf_harvest_sector,
deployment_trip_start_date,	
deployment_trip_end_date,
deployment_trip_pk,	
monitoring_status,	
sampling_strata_deployment_category,
sampling_strata,
sampling_strata_name,	
sampling_strata_selection_rate
;